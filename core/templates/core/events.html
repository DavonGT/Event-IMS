{% extends "core/base.html" %}

{% block title %}All Events{% endblock %}

{% block content %}

<!-- Page Title -->
<div class="title-full">
  <h1 class="page-title">College of Computer Studies Events:</h1>
</div>

<div class="table_container">
  <div class="top-container">
    <!-- Tabs Container -->
    <div class="tabs-container">
      <div class="tabs"> 
        {% for organization in organizations %}
          <a href="{% url 'events_list_filtered' organization.id %}" class="tab {% if organization.id == selected_organization_id %}active{% endif %}">{{ organization.acronym }}</a>
        {% endfor %}
      </div>
    </div>

    <!-- Filter/Search/Add Container -->
    <div class="filter-container">
      
      <button class="add-new-button" onclick="openModal('{% url 'add_event' %}')">+ Add New Event</button>
      {% if user_role == "Admin" %}
        <button class="add-new-button" onclick="openModal('{% url 'add_organization' %}')">+ Add New Org</button>
      {% endif %}
      <button class="add-new-button" onclick="openModal('{% url 'upload_files' %}')">+ Upload Files</button>
      <input type="text" placeholder="Search..." class="search-input" id="searchInput" onkeyup="filterEvents()" />
    </div>
  </div>

  <!-- Events Table -->
  <table class="events-table">
    <thead>
      <tr>
        <th>Event Name</th>
        <th>Date</th>
        <th>Time</th>
        <th>Venue</th>
        <th>Type</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody>
      {% for event in events %}
        <tr>
          <td>{{ event.name }}</td>
          <td>{{ event.start_datetime|date:"m. d. Y" }}</td>
          <td>{{ event.start_datetime|time:"h:i A" }} - {{ event.end_datetime|time:"h:i A" }}</td>
          <td>{{ event.location }}</td>
          <td>{{ event.event_type }}</td>
          <td>
            <button class="action-link" onclick="openModal('{% url 'view_event' event.id %}')">üîç</button>
            {% if request.user == event.host or user_role == 'Admin' or request.user.organization == event.organization%}
              <button class="action-link" onclick="openModal('{% url 'edit_event' event.id %}')">‚úèÔ∏è</button>
            {% endif %}
            {% if user_role == "Admin" %}
              <button class="action-link" onclick="openModal('{% url 'delete_event' event.id %}')">üóëÔ∏è</button>
            {% endif %}
          </td>
        </tr>
      {% empty %}
        <tr>
          <td colspan="6">No events found.</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Event View/Edit Modal -->
<div id="eventModal" class="custom-modal" style="display: none;">
  <div class="custom-modal-overlay" onclick="closeModal()"></div>
  <div class="custom-modal-content">
    <div class="custom-modal-header">
      <h2 id="modal-title" class="modal-title-text">Loading title...</h2>
      <button class="modal-close" onclick="closeModal()">√ó</button>
    </div>
    <div id="modal-body" class="custom-modal-body">
      Loading...
    </div>
  </div>
</div>


<!-- Delete Confirmation Modal -->



<!-- Modal JavaScript -->
<script>

  // Update this line when the page is loaded to include the proper URL template.
  document.addEventListener('DOMContentLoaded', function() {
    // Store the URL template with a placeholder
    deleteUrlTemplate = "{% url 'delete_event' 0 %}".replace('/0/', '/');  // A base URL with placeholder
  });

  function openModal(url) {
    const modal = document.getElementById('eventModal');
    const modalBody = document.getElementById('modal-body');
    const modalTitle = document.getElementById('modal-title');
  
    modal.style.display = 'flex';
    modalBody.innerHTML = 'Loading...';
    modalTitle.textContent = '';
  
    fetch(url, {
      headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(response => {
      const contentType = response.headers.get("content-type");
      return contentType && contentType.includes("application/json")
        ? response.json()
        : response.text();
    })
    .then(data => {
      if (typeof data === 'object' && data.html) {
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = data.html;
        const eventTitle = tempDiv.querySelector('.event-title');
        if (eventTitle) modalTitle.textContent = eventTitle.textContent;
        modalBody.innerHTML = data.html;
      } else {
        modalBody.innerHTML = data;
      }
    });
  }
  

  function closeModal() {
    document.getElementById('eventModal').style.display = 'none';
  }
  function filterEvents() {
    const input = document.getElementById('searchInput');
    const filter = input.value.toLowerCase();
    const table = document.querySelector('.events-table tbody');
    const rows = table.getElementsByTagName('tr');
  
    for (let i = 0; i < rows.length; i++) {
      const cells = rows[i].getElementsByTagName('td');
      let rowMatches = false;
  
      for (let j = 0; j < cells.length - 1; j++) {  // exclude action column
        const cellText = cells[j].textContent || cells[j].innerText;
        if (cellText.toLowerCase().includes(filter)) {
          rowMatches = true;
          break;
        }
      }
  
      rows[i].style.display = rowMatches ? '' : 'none';
    }
  }
  
</script>

{% endblock %}
