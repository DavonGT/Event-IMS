{% extends "core/base.html" %}

{% block title %}All Events{% endblock %}

{% block content %}

<!-- Page Title -->
<div class="title-full">
  <h1 class="page-title">College of Computer Studies Events:</h1>
</div>

<div class="table_container">
  <div class="top-container">
    <!-- Tabs Container -->
    <div class="tabs-container">
      <div class="tabs"> 
        {% for organization in organizations %}
          <a href="{% url 'events_list_filtered' organization.id %}" class="tab {% if organization.id == selected_organization_id %}active{% endif %}">{{ organization.acronym }}</a>
        {% endfor %}
      </div>
    </div>

    <!-- Filter/Search/Add Container -->
    <div class="filter-container">
      <button class="filter-button">Filter</button>
      <input type="text" placeholder="Search..." class="search-input" />
      <button class="add-new-button" onclick="openModal('{% url 'add_event' %}')">+ Add New</button>
    </div>
  </div>

  <!-- Events Table -->
  <table class="events-table">
    <thead>
      <tr>
        <th>Event Name</th>
        <th>Date</th>
        <th>Time</th>
        <th>Venue</th>
        <th>Who</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody>
      {% for event in events %}
        <tr>
          <td>{{ event.name }}</td>
          <td>{{ event.start_datetime|date:"d. m. Y" }}</td>
          <td>{{ event.start_datetime|time:"h:i A" }} - {{ event.end_datetime|time:"h:i A" }}</td>
          <td>{{ event.location }}</td>
          <td>{{ event.who_can_attend }}</td>
          <td>
            <button class="action-link" onclick="openModal('{% url 'view_event' event.id %}')">üîç</button>
            {% if request.user == event.host %}
              <button class="action-link" onclick="openModal('{% url 'edit_event' event.id %}')">‚úèÔ∏è</button>
              <button class="action-link" onclick="openDeleteModal('{{ event.id }}')">üóëÔ∏è</button>
            {% endif %}
          </td>
        </tr>
      {% empty %}
        <tr>
          <td colspan="6">No events found.</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Event View/Edit Modal -->
<div id="eventModal" class="custom-modal" style="display: none;">
  <div class="custom-modal-overlay" onclick="closeModal()"></div>
  <div class="custom-modal-content">
    <div class="custom-modal-header">
      <h2 id="modal-title" class="modal-title-text">Loading title...</h2>
      <button class="modal-close" onclick="closeModal()">√ó</button>
    </div>
    <div id="modal-body" class="custom-modal-body">
      Loading...
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="custom-modal" style="display: none;">
  <div class="custom-modal-overlay" onclick="closeDeleteModal()"></div>
  <div class="custom-modal-content">
    <div class="custom-modal-header">
      <h2 class="event-title">Confirm Deletion?</h2>
      <button class="modal-close" onclick="closeDeleteModal()">√ó</button>
    </div>
    <div class="custom-modal-body">
      <p>This action cannot be undone.</p>
      <div class="button-row">
        <button id="confirmDeleteButton" class="delete-button" onclick="confirmDelete()">Yes, Delete</button>
        <button class="cancel-button" onclick="closeDeleteModal()">Cancel</button>
      </div>
    </div>
  </div>
</div>


<!-- Modal JavaScript -->
<!-- Modal JavaScript -->
<script>
  let eventToDelete = null;
  let deleteUrlTemplate = null;  // Store the delete URL template

  // Update this line when the page is loaded to include the proper URL template.
  document.addEventListener('DOMContentLoaded', function() {
    // Store the URL template with a placeholder
    deleteUrlTemplate = "{% url 'delete_event' 0 %}".replace('/0/', '/');  // A base URL with placeholder
  });

  function openModal(url) {
    const modal = document.getElementById('eventModal');
    const modalBody = document.getElementById('modal-body');
    const modalTitle = document.getElementById('modal-title');

    modal.style.display = 'flex';
    modalBody.innerHTML = 'Loading...';
    modalTitle.textContent = '';

    fetch(url, {
      headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(response => {
      const contentType = response.headers.get("content-type");
      if (contentType && contentType.includes("application/json")) {
        return response.json();
      } else {
        return response.text();
      }
    })
    .then(data => {
      if (typeof data === 'object' && data.html) {
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = data.html;
        const eventTitle = tempDiv.querySelector('.event-title');
        if (eventTitle) modalTitle.textContent = eventTitle.textContent;
        modalBody.innerHTML = data.html;
      } else {
        modalBody.innerHTML = data;
      }
    });
  }

  function closeModal() {
    document.getElementById('eventModal').style.display = 'none';
  }

  // Delete modal functions
  function openDeleteModal(eventId) {
    eventToDelete = eventId; // Store the event ID to delete
    document.getElementById('deleteModal').style.display = 'flex';
  }

  function closeDeleteModal() {
    document.getElementById('deleteModal').style.display = 'none';
    eventToDelete = null; // Reset the stored event ID
  }

  function confirmDelete() {
    if (eventToDelete) {
      // Replace the placeholder with the actual event ID
      const deleteUrl = deleteUrlTemplate.replace('0', eventToDelete);
      window.location.href = deleteUrl;  // Redirect to the delete URL
    }
  }
</script>

{% endblock %}
