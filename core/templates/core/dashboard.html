{% extends 'core/base.html' %}
{% load static %}

{% block title %}Dashboard{% endblock %}

{% block content %}

{% block extra_css %}
<style>
  #calendar,
  .fc-scroller,
  .fc-daygrid-body,
  .fc-daygrid-body-natural {
    overflow: hidden !important;
  }
  .fc {
    height: 100% !important;
    min-height: 600px;
    background: #fff;
    border-radius: 16px;
    box-shadow: 0 4px 24px rgba(130,39,128,0.13);
    padding: 2rem 1.5rem 2.5rem 1.5rem;
    margin-top: 2rem;
    border: 2px solid #822780;
    font-family: 'Segoe UI', 'Cal Sans', Arial, sans-serif;
    overflow: visible !important;
  }
  .content-layout {
    min-height: 900px !important;
    height: 900px !important;
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    align-items: stretch;
  }
  .main-content {
    min-height: 850px;
    height: 850px;
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    align-items: stretch;
  }
  #calendar {
    min-height: 900px;
    height: 100%;
   
  }
  .fc-toolbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    background: #f5eeff;
    border-radius: 12px;
    padding: 0.5rem 1rem;
  }
  .fc-button {
    background: #822780;
    color: #fff;
    border: none;
    border-radius: 8px;
    padding: 0.5rem 1.3rem;
    font-size: 1rem;
    margin: 0 0.3rem;
    transition: background 0.2s, box-shadow 0.2s;
    box-shadow: 0 2px 8px rgba(130,39,128,0.10);
    font-weight: 600;
    letter-spacing: 0.5px;
  }
  .fc-button:hover, .fc-button-active {
    background: #660f60;
    box-shadow: 0 4px 16px rgba(130,39,128,0.18);
  }
  .fc-daygrid-day {
    transition: background 0.2s, box-shadow 0.2s;
    cursor: pointer;
    border-radius: 10px;
    background: #faf7fe;
  }
  .fc-daygrid-day.fc-day-today {
    background: #f5eeff !important;
    border-radius: 10px;
    box-shadow: 0 0 0 2px #822780;
  }
  .fc-day[data-date][style*="background-color"] {
    box-shadow: 0 0 0 2px #822780;
    border-radius: 10px;
  }
  .fc-event {
    background: #822780 !important;
    color: #fff !important;
    border: none !important;
    border-radius: 8px !important;
    font-weight: 600;
    font-size: 1rem;
    padding: 4px 12px !important;
    margin-bottom: 4px;
    box-shadow: 0 2px 8px rgba(130,39,128,0.10);
    transition: box-shadow 0.2s, background 0.2s;
  }
  .fc-event:hover {
    box-shadow: 0 4px 16px rgba(130,39,128,0.18);
    background: #660f60 !important;
  }
  .fc-daygrid-event-dot {
    border-color: #822780 !important;
  }
  .fc-popover {
    border-radius: 12px !important;
    box-shadow: 0 4px 24px rgba(130,39,128,0.13) !important;
  }
  .fc-scrollgrid {
    border-radius: 16px;
    overflow: hidden;
  }
  .fc-daygrid-day-number {
    font-weight: 700;
    color: #822780;
    font-size: 1.1rem;
    margin-bottom: 2px;
    padding-right: 4px;
  }
  .fc-daygrid-day-top {
    padding-top: 8px;
    padding-right: 8px;
  }
  .fc-daygrid-day-bg {
    border-radius: 10px;
  }
  .fc-daygrid-day.fc-day-today .fc-daygrid-day-number {
    color: #660f60;
  }
  .fc-toolbar-title {
    font-size: 1.6rem;
    font-weight: 700;
    color: #822780;
    letter-spacing: 0.5px;
    font-family: 'Cal Sans', 'Segoe UI', Arial, sans-serif;
  }
  .dashboard-stats-filters {
    background: #f5eeff;
    border-radius: 10px;
    box-shadow: 0 2px 8px rgba(130,39,128,0.04);
    padding: 1rem 2rem;
    margin-bottom: 1.5rem;
    border: 1.5px solid #822780;
  }
  .event-count {
    color: #822780;
    font-size: 1.2rem;
    font-weight: bold;
  }
  .filter-select, .filter-date {
    padding: 0.4rem 0.8rem;
    border-radius: 6px;
    border: 1px solid #822780;
    background: #fff;
    font-size: 1rem;
    margin-right: 0.5rem;
    color: #822780;
  }
  .filter-select:focus, .filter-date:focus {
    outline: 2px solid #822780;
    border-color: #822780;
  }
  .today-button {
    background: #822780;
    color: #fff;
    border: none;
    border-radius: 6px;
    padding: 0.5rem 1.2rem;
    font-size: 1rem;
    cursor: pointer;
    transition: background 0.2s;
    box-shadow: 0 1px 4px rgba(130,39,128,0.08);
  }
  .today-button:hover {
    background: #660f60;
  }
  .search-section {
    display: flex;
    align-items: center;
    gap: 1rem;
  }
  .search-input {
    padding: 0.5rem 1rem;
    border-radius: 6px;
    border: 1px solid #822780;
    font-size: 1rem;
    width: 220px;
    color: #822780;
  }
  .search-input:focus {
    outline: 2px solid #822780;
    border-color: #822780;
  }
  .dashboard-title {
    color: #822780;
    font-weight: 700;
    letter-spacing: 0.5px;
  }
  .dashboard-subtitle {
    color: #660f60;
    font-weight: 600;
  }
  .search-label {
    color: #822780;
    font-size: 1.3rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
    display: block;
    letter-spacing: 0.5px;
  }
  @media (max-width: 700px) {
    .fc {
      padding: 0.5rem 0.2rem 1rem 0.2rem;
    }
    .fc-toolbar-title {
      font-size: 1.1rem;
    }
    .dashboard-stats-filters {
      flex-direction: column;
      gap: 1rem;
      padding: 1rem 0.5rem;
    }
  }
  .tippy-box {
    max-width: 500px !important;
    font-size: 20px !important;
    line-height: 1;
    padding: 10px;
  }
  .tippy-content {
    padding: 10px !important;
  }
</style>

<!-- Tippy.js for tooltips -->
<link rel="stylesheet" href="https://unpkg.com/tippy.js@6/dist/tippy.css" />
{% endblock %}
{% block extra_js %}
<script src="https://unpkg.com/@popperjs/core@2"></script>
<script src="https://unpkg.com/tippy.js@6"></script>
{% endblock %}

<div class="dashboard-container">
  <label for="searchInput" class="search-label">Extension Events and Activities Information Management System</label>
  <!-- Event Count and Filters -->
  <div class="dashboard-stats-filters">
    <div class="event-count">
      Total Events: <span id="eventCount">0</span>
    </div>
    <div class="filters">
      <select id="typeFilter" class="filter-select">
        <option value="">All Types</option>
      </select>
      <select id="orgFilter" class="filter-select">
        <option value="">All Organizations</option>
      </select>
      <input type="date" id="startDateFilter" class="filter-date" />
      <span>to</span>
      <input type="date" id="endDateFilter" class="filter-date" />
      <button id="clearFilters" class="today-button">Clear Filters</button>
    </div>
  </div>
  <!-- Header Container -->
  <div class="header-container">
    
    <!-- LEFT SIDE: Title + Search -->
     
  <div class="left-header">
    
    <div class="search-section">
      <div class="search-group">
        <input type="text" placeholder="Search..." class="search-input" id="searchInput" />
      </div>
      <button class="today-button" id="todayButton">TODAY</button>
    </div>
  </div>

    <!-- RIGHT SIDE: User Greeting + Logo -->
  <div class="title-logo-user">
    <div class="user-text">
      {% if request.user.first_name %}
        <h1 class="dashboard-title">Hello, {{ request.user.get_full_name|title }}!</h1>
      {% else %}
        <h1 class="dashboard-title">Hello, {{ request.user.username|title }}!</h1>
        {% endif %}
      {% if request.user.is_superuser or request.user.is_staff %}
        <p class="dashboard-subtitle">Admin</p>
      {% else %}
        <p class="dashboard-subtitle">Student</p>
      {% endif %}
    </div>
    <img src="{% static 'core/images/ccs_logo.png' %}" alt="Logo" class="logo-img">
  </div>

  </div>
</div>

</div>


  <!-- Calendar Layout Only -->
  <div class="content-layout">
    <div class="main-content">
      <div id="calendar"></div>
    </div>
  </div>
</div>



<script>
  document.addEventListener('DOMContentLoaded', function () {
    const calendarEl = document.getElementById('calendar');
    const eventsData = JSON.parse('{{ events_json|safe }}');
    const searchInput = document.getElementById('searchInput');
    const todayButton = document.getElementById('todayButton');
    const eventCountEl = document.getElementById('eventCount');
    const typeFilter = document.getElementById('typeFilter');
    const orgFilter = document.getElementById('orgFilter');
    const startDateFilter = document.getElementById('startDateFilter');
    const endDateFilter = document.getElementById('endDateFilter');
    const clearFilters = document.getElementById('clearFilters');

    let calendar; // Declare calendar variable at a higher scope

    // Populate filter dropdowns
    const uniqueTypes = [...new Set(eventsData.map(e => e.type))].filter(Boolean);
    uniqueTypes.forEach(type => {
      const opt = document.createElement('option');
      opt.value = type;
      opt.textContent = type;
      typeFilter.appendChild(opt);
    });
    const uniqueOrgs = [...new Set(eventsData.map(e => e.organization))].filter(Boolean);
    uniqueOrgs.forEach(org => {
      const opt = document.createElement('option');
      opt.value = org;
      opt.textContent = org;
      orgFilter.appendChild(opt);
    });

    // Group events by local date
    const eventsByDate = {};
    eventsData.forEach(event => {
      const dateObj = new Date(event.date);
      const dateKey = dateObj.getFullYear() + '-' +
                      String(dateObj.getMonth() + 1).padStart(2, '0') + '-' +
                      String(dateObj.getDate()).padStart(2, '0');

      if (!eventsByDate[dateKey]) eventsByDate[dateKey] = [];
      eventsByDate[dateKey].push(event);
    });

    // Helper: filter events
    function getFilteredEvents() {
      let filtered = eventsData;
      const typeVal = typeFilter.value;
      const orgVal = orgFilter.value;
      const startVal = startDateFilter.value;
      const endVal = endDateFilter.value;
      if (typeVal) filtered = filtered.filter(e => e.type === typeVal);
      if (orgVal) filtered = filtered.filter(e => e.organization === orgVal);
      if (startVal) filtered = filtered.filter(e => e.date >= startVal);
      if (endVal) filtered = filtered.filter(e => e.date <= endVal);
      return filtered;
    }

    // Helper: update event count
    function updateEventCount(count) {
      eventCountEl.textContent = count;
    }

    // Helper: render calendar events
    function renderCalendarEvents(events) {
      calendar.removeAllEvents();
      events.forEach(event => {
        calendar.addEvent({
          title: event.name,
          date: event.date,
          extendedProps: {
            description: event.description,
            location: event.location,
            organization: event.organization,
            type: event.type
          }
        });
      });
      updateEventCount(events.length);
    }

    // Initial calendar events
    const calendarEvents = eventsData.map(event => ({
      title: event.name,
      date: event.date,
      extendedProps: {
        description: event.description,
        location: event.location,
        organization: event.organization,
        type: event.type
      }
    }));

    calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: 'dayGridMonth',
      events: calendarEvents,
      headerToolbar: {
        left: 'prev,next today',
        center: 'title',
        right: 'dayGridMonth,timeGridWeek,timeGridDay,listMonth'
      },
      buttonText: {
        today: 'Today',
        month: 'Month',
        week: 'Week',
        day: 'Day',
        list: 'List'
      },
      navLinks: true,
      selectable: true,
      selectMirror: true,
      eventClick: function(info) {
        // Show a modal or alert with event details for better UX
        const e = info.event;
        const details = `
          <div style='font-size:1.1rem;'>
            <strong>${e.title}</strong><br>
            <b>Date:</b> ${e.startStr.split('T')[0]}<br>
            <b>Location:</b> ${e.extendedProps.location}<br>
            <b>Description:</b> ${e.extendedProps.description}<br>
            <b>Organization:</b> ${e.extendedProps.organization}<br>
            <b>Type:</b> ${e.extendedProps.type}
          </div>
        `;
        tippy(document.body, {
          content: details,
          allowHTML: true,
          trigger: 'manual',
          placement: 'auto',
          theme: 'light-border',
          onHidden(instance) { instance.destroy(); },
        }).show();
        setTimeout(() => {
          document.querySelectorAll('.tippy-box').forEach(box => box.parentNode._tippy.hide());
        }, 3500);
      },
      dayMaxEvents: 3,
      moreLinkClick: 'popover',
      dayCellDidMount: function(info) {
        const d = info.date;
        const dateKey = d.getFullYear() + '-' +
                        String(d.getMonth() + 1).padStart(2, '0') + '-' +
                        String(d.getDate()).padStart(2, '0');
        const events = eventsByDate[dateKey];
        if (events && events.length > 0) {
          const content = events.map(e => 
            `<strong>${e.name}</strong><br>` +
            `üìÖ ${e.date}<br>` +
            `üìç ${e.location}<br>` +
            `üìù ${e.description}<br>` +
            `üè¢ ${e.organization}<br>` +
            `üë§ ${e.type}`
          ).join('<hr>');
          tippy(info.el, {
            content: content,
            allowHTML: true,
            placement: 'bottom',
            theme: 'dark-border'
          });
        }
      },
      datesSet: function(info) {
        // Default FullCalendar title UX
      }
    });

    calendar.render();
    updateEventCount(eventsData.length);

    // Search functionality
    searchInput.addEventListener('input', function() {
      const searchTerm = this.value.toLowerCase();
      const allEvents = calendar.getEvents();
      let matchingEvents = [];
      allEvents.forEach(event => {
        const eventTitle = event.title.toLowerCase();
        const eventDescription = event.extendedProps.description.toLowerCase();
        const eventLocation = event.extendedProps.location.toLowerCase();
        const eventOrganization = event.extendedProps.organization.toLowerCase();
        if (eventTitle.includes(searchTerm) || 
            eventDescription.includes(searchTerm) || 
            eventLocation.includes(searchTerm) || 
            eventOrganization.includes(searchTerm)) {
          event.setProp('display', 'auto');
          matchingEvents.push(event);
          // Highlight the day cell
          const dateStr = event.startStr.split('T')[0];
          const dayEl = document.querySelector(`.fc-day[data-date="${dateStr}"]`);
          if (dayEl) {
            dayEl.style.backgroundColor = 'rgba(255, 255, 0, 0.2)';
          }
        } else {
          event.setProp('display', 'none');
        }
      });
      updateEventCount(matchingEvents.length);
      // If we found matches and have search term, navigate to most recent match
      if (matchingEvents.length > 0 && searchTerm.length > 0) {
        // Sort matching events by date (newest first)
        matchingEvents.sort((a, b) => b.start - a.start);
        // Get the most recent event
        const mostRecentEvent = matchingEvents[0];
        // Navigate to that date
        calendar.gotoDate(mostRecentEvent.start);
      }
    });

    // Clear highlighting when search is cleared
    searchInput.addEventListener('keyup', function() {
      if (this.value === '') {
        const highlightedDays = document.querySelectorAll('.fc-day[style*="background-color"]');
        highlightedDays.forEach(day => {
          day.style.backgroundColor = '';
        });
        // Reset view to current date when search is cleared
        calendar.today();
        updateEventCount(calendar.getEvents().length);
      }
    });

    // Today button functionality
    todayButton.addEventListener('click', function() {
      calendar.today();
      searchInput.value = '';
      // Clear any highlighting
      const highlightedDays = document.querySelectorAll('.fc-day[style*="background-color"]');
      highlightedDays.forEach(day => {
        day.style.backgroundColor = '';
      });
      // Reset all events to visible
      calendar.getEvents().forEach(event => {
        event.setProp('display', 'auto');
      });
      updateEventCount(calendar.getEvents().length);
    });

    // Filter functionality
    function applyFilters() {
      const filtered = getFilteredEvents();
      renderCalendarEvents(filtered);
      // Remove search highlight and clear search
      searchInput.value = '';
      const highlightedDays = document.querySelectorAll('.fc-day[style*="background-color"]');
      highlightedDays.forEach(day => {
        day.style.backgroundColor = '';
      });
    }
    [typeFilter, orgFilter, startDateFilter, endDateFilter].forEach(f => f.addEventListener('change', applyFilters));
    clearFilters.addEventListener('click', function() {
      typeFilter.value = '';
      orgFilter.value = '';
      startDateFilter.value = '';
      endDateFilter.value = '';
      applyFilters();
    });
  });
</script>

{% endblock %}
