{% extends 'core/base.html' %}
{% load static %}

{% block title %}Dashboard{% endblock %}

{% block content %}

{% block extra_css %}
<style>
  #calendar,
  .fc-scroller,
  .fc-daygrid-body,
  .fc-daygrid-body-natural {
    overflow: hidden !important;
  }

  .fc {
    height: auto !important;
  }
  
  .fc-event-hidden {
    display: none !important;
  }
</style>

<!-- Tippy.js for tooltips -->
<link rel="stylesheet" href="https://unpkg.com/tippy.js@6/dist/tippy.css" />
{% endblock %}
{% block extra_js %}
<script src="https://unpkg.com/@popperjs/core@2"></script>
<script src="https://unpkg.com/tippy.js@6"></script>
{% endblock %}

<div class="dashboard-container">

  <!-- Title Section on Top -->
  <div class="title-container">
    {% if request.user.first_name %}
      <h1 class="dashboard-title">Hello, {{ request.user.get_full_name|title }}!</h1>
    {% else %}
      <h1 class="dashboard-title">Hello, {{ request.user.username|title }}!</h1>
    {% endif %}
    {% if request.user.is_superuser or request.user.is_staff %}
      <p class="dashboard-subtitle">Admin</p>
    {% else %}
      <p class="dashboard-subtitle">Student</p>
    {% endif %}

    </div>

  <!-- Calendar Layout Only -->
  <div class="content-layout">
    <div class="main-content">
      <div id="calendar"></div>
    </div>
  </div>
</div>



<script>
  document.addEventListener('DOMContentLoaded', function () {
    const calendarEl = document.getElementById('calendar');
    const eventsData = JSON.parse('{{ events_json|safe }}');
    
    let calendar; // Declare calendar variable at a higher scope

    // Group events by local date
    const eventsByDate = {};
    eventsData.forEach(event => {
      const dateObj = new Date(event.date);
      const dateKey = dateObj.getFullYear() + '-' +
                      String(dateObj.getMonth() + 1).padStart(2, '0') + '-' +
                      String(dateObj.getDate()).padStart(2, '0');

      if (!eventsByDate[dateKey]) eventsByDate[dateKey] = [];
      eventsByDate[dateKey].push(event);
    });

    const calendarEvents = eventsData.map(event => ({
      title: event.name,
      date: event.date,
      extendedProps: {
        description: event.description,
        location: event.location,
        organization: event.organization,
        type: event.type
      }
    }));

    calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: 'dayGridMonth',
      events: calendarEvents,
      headerToolbar: {
        left: 'customTitle',
        center: '',
        right: 'prev,next'
      },
      customButtons: {
        customTitle: {
          text: '',
          click: function () {}
        }
      },
      dayCellDidMount: function(info) {
        const d = info.date;
        const dateKey = d.getFullYear() + '-' +
                        String(d.getMonth() + 1).padStart(2, '0') + '-' +
                        String(d.getDate()).padStart(2, '0');

        const events = eventsByDate[dateKey];
        if (events && events.length > 0) {
          const content = events.map(e => 
            `<strong>${e.name}</strong><br>` +
            `📅 ${e.date}<br>` +
            `📍 ${e.location}<br>` +
            `📝 ${e.description}<br>` +
            `🏢 ${e.organization}<br>` +
            `👤 ${e.type}`
          ).join('<hr>');

          tippy(info.el, {
            content: content,
            allowHTML: true,
            placement: 'top',
            theme: 'light-border'
          });
        }
      },
      datesSet: function(info) {
        const midDate = new Date(info.start);
        midDate.setDate(midDate.getDate() + 15);
        const monthName = midDate.toLocaleString('default', { month: 'long' });
        const year = midDate.getFullYear();

        const customTitleEl = document.querySelector('.fc-customTitle-button');
        if (customTitleEl) {
          customTitleEl.innerHTML = `
            <span class="calendar-month">${monthName}</span>
            <span class="calendar-year">${year}</span>
          `;
        }
      }
    });

    calendar.render();
    
    // Search functionality
  searchInput.addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();
    const allEvents = calendar.getEvents();
    let matchingEvents = [];
    
    allEvents.forEach(event => {
      const eventTitle = event.title.toLowerCase();
      const eventDescription = event.extendedProps.description.toLowerCase();
      const eventLocation = event.extendedProps.location.toLowerCase();
      const eventOrganization = event.extendedProps.organization.toLowerCase();
      
      if (eventTitle.includes(searchTerm) || 
          eventDescription.includes(searchTerm) || 
          eventLocation.includes(searchTerm) || 
          eventOrganization.includes(searchTerm)) {
        event.setProp('display', 'auto');
        matchingEvents.push(event);
        
        // Highlight the day cell
        const dateStr = event.startStr.split('T')[0];
        const dayEl = document.querySelector(`.fc-day[data-date="${dateStr}"]`);
        if (dayEl) {
          dayEl.style.backgroundColor = 'rgba(255, 255, 0, 0.2)';
        }
      } else {
        event.setProp('display', 'none');
      }
    });
    
    // If we found matches and have search term, navigate to most recent match
    if (matchingEvents.length > 0 && searchTerm.length > 0) {
      // Sort matching events by date (newest first)
      matchingEvents.sort((a, b) => b.start - a.start);
      
      // Get the most recent event
      const mostRecentEvent = matchingEvents[0];
      
      // Navigate to that date
      calendar.gotoDate(mostRecentEvent.start);
      }
    });
    
    // Clear highlighting when search is cleared
    searchInput.addEventListener('keyup', function() {
      if (this.value === '') {
        const highlightedDays = document.querySelectorAll('.fc-day[style*="background-color"]');
        highlightedDays.forEach(day => {
          day.style.backgroundColor = '';
        });
        // Reset view to current date when search is cleared
        calendar.today();
      }
    });
    
    // Today button functionality
    todayButton.addEventListener('click', function() {
      calendar.today();
      searchInput.value = ''; // Clear search when going to today
      // Clear any highlighting
      const highlightedDays = document.querySelectorAll('.fc-day[style*="background-color"]');
      highlightedDays.forEach(day => {
        day.style.backgroundColor = '';
      });
      // Reset all events to visible
      calendar.getEvents().forEach(event => {
        event.setProp('display', 'auto');
      });
    });
  });
</script>

{% endblock %}
